<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêçVIBORITA COSMICAüöÄ</title>
    
    <link rel="apple-touch-icon" href="https://i.postimg.cc/66HYTMsy/Icono.png">
    <link rel="icon" href="https://i.postimg.cc/66HYTMsy/Icono.png">

    <meta property="og:title" content="üêç VIBORITA C√ìSMICA üöÄ">
    <meta property="og:description" content="¬øCrees que puedes sobrevivir al vac√≠o del espacio? Gu√≠a a la viborita en esta odisea retro, devora manzanas c√≥smicas y salta entre mundos antes de que un alien decida que eres su cena.">
    <meta property="og:image" content="https://i.postimg.cc/QCnbPdg6/Previsualizacion.jpg">
    <meta property="og:url" content="https://dxgames.com"> <meta name="twitter:card" content="summary_large_image">

    <style>
        /* --- ESTILOS GENERALES --- */
        body {
            display: flex;
            justify-content: flex-start; 
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #0b0c10;
            font-family: sans-serif; 
            color: #ecf0f1;
            flex-direction: column;
            position: relative;
            overflow: hidden; 
        }

        /* Contenedor Principal para Escalado Autom√°tico */
        #main-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transform-origin: center top; 
            transition: transform 0.3s ease, margin-top 0.3s ease; 
            padding-top: 10px;
            width: 100%;
        }
        
        /* Lienzo de Estrellas de Fondo (Toda la pantalla) */
        #bodyStarCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        /* --- Pantalla de Carga --- */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #0b0c10;
            color: #7fffd4;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            text-align: center;
            z-index: 100;
        }
        #loading-spinner {
            border: 4px solid rgba(127, 255, 212, 0.2);
            border-top: 4px solid #7fffd4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-top: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        h1 {
            color: #7fffd4; 
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 3px 3px #1a5c4e;
            text-align: center;
            z-index: 10;
        }

        /* --- MEN√öS --- */
        #main-menu, #mode-select-menu, #difficulty-select-menu, #settings-menu, #how-to-play-menu, #about-menu {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 30px;
            border: 5px solid #00ffff;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.7);
            background-color: rgba(0, 0, 0, 0.85);
            min-width: 320px;
            z-index: 10;
            text-align: center;
            border-radius: 10px;
        }
        
        /* Contenedores de Juego */
        #game-container, #game-controls { 
            display: none; 
            z-index: 10;
        }

        /* Estilo de botones de Men√∫ */
        .menu-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2em;
            cursor: pointer;
            margin: 10px 0;
            border-radius: 5px;
            width: 100%;
            transition: background-color 0.3s ease, transform 0.1s;
            text-align: center;
            text-decoration: none; 
            font-weight: bold;
        }
        
        .menu-button.unavailable {
            background-color: #555;
            color: #aaa;
            cursor: not-allowed;
            opacity: 0.8; 
            border: 1px solid #777;
        }

        .menu-button:hover:not(.unavailable) {
            background-color: #2980b9;
            transform: scale(1.02);
        }

        .back-button {
            background-color: #e74c3c;
            margin-top: 20px;
        }
        .back-button:hover {
            background-color: #c0392b;
        }

        .home-button {
            background-color: #8e44ad;
            margin-top: 10px;
        }
        .home-button:hover {
            background-color: #71368a;
        }
        
        /* --- BOTONES SOCIALES CIRCULARES --- */
        .social-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            margin-bottom: 15px;
        }

        .social-icon-link {
            display: block;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid #7fffd4;
            box-shadow: 0 0 15px rgba(127, 255, 212, 0.5);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .social-icon-link img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .social-icon-link:hover {
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 0 25px rgba(127, 255, 212, 0.9);
            border-color: #fff;
        }
        
        /* --- ESTILOS DEL JUEGO --- */
        #game-container {
            border: 5px solid #00ffff;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.7);
            position: relative;
            overflow: hidden;
            background-color: #000000;
        }

        #starCanvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0; 
        }
        
        #gameCanvas {
            background-color: transparent;
            display: block;
            position: relative;
            z-index: 1;
        }

        #game-controls {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            width: 600px; 
            margin-top: 10px;
            margin-bottom: 5px;
            z-index: 10;
        }

        #pauseButton {
            background-color: rgba(0, 0, 0, 0.6); 
            color: #7fffd4;
            border: 2px solid #7fffd4; 
            padding: 8px 20px; 
            cursor: pointer;
            font-size: 1.1em; 
            border-radius: 20px;
            z-index: 5;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(127, 255, 212, 0.3); 
            transition: all 0.2s;
        }
        
        #pauseButton:hover {
            background-color: #7fffd4;
            color: #000;
        }

        /* Pantalla de Pausa/Game Over */
        #pause-screen, #game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            text-align: center;
            display: none; 
            z-index: 20; 
        }
        
        #game-over-screen h2 { color: #e74c3c; text-shadow: 0 0 10px #e74c3c; margin-bottom: 10px;}
        #pause-screen h2 { color: #f1c40f; text-shadow: 0 0 10px #f1c40f; }

        #game-over-screen button, #pause-screen button {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 0.6em;
            cursor: pointer;
            margin-top: 15px;
            border-radius: 50px;
            transition: background-color 0.3s ease, transform 0.2s;
            font-family: sans-serif; 
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            width: 80%;
            max-width: 300px;
        }
        
        #game-over-screen button.home-button, #pause-screen button.home-button {
            background-color: #8e44ad;
        }

        #game-over-screen button:hover, #pause-screen button:hover {
            filter: brightness(1.1);
            transform: scale(1.05);
        }
        
        /* --- MARCADOR --- */
        #score-board {
            font-size: 1.1em;
            color: #ecf0f1;
            text-align: left; 
            z-index: 10;
            background: rgba(0,0,0,0.5);
            padding: 5px 15px;
            border-radius: 15px;
            border: 1px solid #555;
        }
        #score-board span {
            color: #f1c40f;
            font-weight: bold;
        }
        #record-display { color: #ff6b6b !important; margin-left: 10px; }

        .menu-content {
            padding-top: 5px;
            max-width: 320px;
            text-align: left;
            font-size: 0.95em;
            line-height: 1.5;
        }

        .menu-content p, .menu-content ul {
            margin-top: 8px;
            margin-bottom: 12px;
        }
    </style>
</head>
<body>
    <canvas id="bodyStarCanvas"></canvas> 
    
    <div id="loading-screen">
        <h1>Cargando Recursos C√≥smicos...</h1>
        <div id="loading-spinner"></div>
    </div>
    
    <div id="main-wrapper">
        
        <h1>üêçVIBORITA COSMICAüöÄ</h1>

        <audio id="backgroundMusic" loop>
            <source src="https://archive.org/download/eric-skiff-underclocked-no-copyright-8-bit-music-background_202512/Eric%20Skiff%20-%20Underclocked%20%20NO%20COPYRIGHT%208-bit%20Music%20%20Background.mp3" type="audio/mp3">
            Tu navegador no soporta el elemento de audio.
        </audio>

        <div id="main-menu">
            <button id="mainPlayButton" class="menu-button">üöÄ Jugar</button> 
            <button id="mainSettingsButton" class="menu-button">‚öôÔ∏è Ajustes</button>
            <button id="mainHowToPlayButton" class="menu-button">‚ùì ¬øC√≥mo se Juega?</button>
            <button id="mainAboutButton" class="menu-button">‚ÑπÔ∏è Acerca del Juego</button>
        </div>

        <div id="mode-select-menu">
            <h2>Selecciona Modo</h2>
            <button id="arcadeModeButton" class="menu-button">üéÆ Arcade</button>
            <button class="menu-button unavailable">‚ò†Ô∏è Supervivencia (Pronto)</button>
            <button class="menu-button back-button" data-target="main-menu">‚Ü©Ô∏è Volver</button>
        </div>
        
        <div id="difficulty-select-menu">
            <h2>Dificultad</h2>
            <div id="difficulty-buttons-container" style="width: 100%;"></div>
            <button class="menu-button back-button" data-target="mode-select-menu">‚Ü©Ô∏è Volver</button>
        </div>

        <div id="settings-menu">
            <h2>Ajustes</h2>
            <button id="toggleSoundButton" class="menu-button">üîä Sonido: ON</button>
            <button id="toggleVibrationButton" class="menu-button">üì≥ Vibraci√≥n: ON</button>
            <button class="menu-button back-button" data-target="main-menu">‚Ü©Ô∏è Volver</button>
        </div>

        <div id="how-to-play-menu">
            <h2>¬øC√≥mo se Juega?</h2>
            <div class="menu-content">
                <p><strong>Objetivo:</strong> Gu√≠a a la v√≠borita a trav√©s del cosmos. Come para crecer y ganar puntos.</p>
                <ul>
                    <li><strong>Manzana Cosmica:</strong> Te da puntos y te hace crecer.</li>
                    <li><strong>OVNI:</strong> Aparece ocasionalmente. ¬°Al comerlo te teletransporta a un nuevo mundo! (Cambia el escenario).</li>
                    <li><strong>Aliens:</strong> Evita chocar con ellos.</li>
                </ul>
                <p><strong>Controles:</strong> Usa las flechas del teclado o desliza el dedo en la pantalla (m√≥vil).</p>
            </div>
            <button class="menu-button back-button" data-target="main-menu">‚Ü©Ô∏è Volver</button>
        </div>

        <div id="about-menu">
            <h2>Acerca del Juego</h2>
            <div class="menu-content" style="text-align: center;">
                <p><strong>Creado por DX Games</strong></p>
                <p>Versi√≥n: v1.2</p>
                
                <h3 style="margin-top: 20px; color: #7fffd4;">¬°S√çGUENOS!</h3>
                
                <div class="social-container">
                    <a href="https://www.facebook.com/profile.php?id=61584974510654" target="_blank" class="social-icon-link" title="Facebook">
                        <img src="https://i.postimg.cc/4xVBSV05/Facebook_Logo_(2019).png" alt="Facebook">
                    </a>
                    
                    <a href="https://www.tiktok.com/@dxgamesofficial?_r=1&_t=ZS-923fS5rjZZv" target="_blank" class="social-icon-link" title="TikTok">
                        <img src="https://i.postimg.cc/XYtXpyNz/images_(11).jpg" alt="TikTok">
                    </a>
                </div>
                
                <p style="font-size: 0.8em; margin-top: 15px; color: #aaa;">Gracias por jugar esta aventura c√≥smica.</p>
            </div>
            <button class="menu-button back-button" data-target="main-menu">‚Ü©Ô∏è Volver</button>
        </div>

        <div id="game-controls">
            <div id="score-board">
                Pts: <span id="current-score">0</span> | Nvl: <span id="current-level">1</span>
                <span id="record-display">| R√©cord: 0</span> 
            </div>
            <button id="pauseButton">‚è∏Ô∏è Pausa</button> 
        </div>

        <div id="game-container">
            <canvas id="starCanvas" width="600" height="600"></canvas>
            <canvas id="gameCanvas" width="600" height="600"></canvas>
            
            <div id="pause-screen">
                <h2>PAUSA</h2>
                <p>Juego Detenido</p>
                <button id="resumeButton">‚ñ∂Ô∏è Reanudar</button>
                <button id="pauseToMenuButton" class="home-button">üè† Men√∫ Principal</button>
            </div>
            
            <div id="game-over-screen">
                <h2>¬°EXPLOSI√ìN C√ìSMICA!</h2>
                <p>Dificultad: <span id="final-difficulty" style="color: #00ffff;"></span></p>
                <p>Puntuaci√≥n: <span id="final-score" style="color: #f1c40f; font-size: 1.5em;">0</span></p>
                <p>Nivel: <span id="final-level">1</span></p>
                <button id="restartButton">üîÑ Reiniciar Misi√≥n</button>
                <button id="gameOverToMenuButton" class="home-button">üè† Men√∫ Principal</button>
            </div>
        </div>

    </div> 
    <script>
        // --- AUTO-SCALING / RESPONSIVE LOGIC ---
        function resizeGame() {
            const wrapper = document.getElementById('main-wrapper');
            const availableHeight = window.innerHeight;
            const availableWidth = window.innerWidth;
            
            const baseWidth = 650; 
            const baseHeight = 850; 

            const scaleH = availableHeight / baseHeight;
            const scaleW = availableWidth / baseWidth;
            
            let scale = Math.min(scaleH, scaleW);
            
            if (scale > 1.1) scale = 1.1; 
            scale = scale * 0.95;

            const scaledHeight = baseHeight * scale;
            let marginTop = 0;
            if (availableHeight > scaledHeight) {
                marginTop = (availableHeight - scaledHeight) / 2;
            }

            wrapper.style.transform = `scale(${scale})`;
            wrapper.style.marginTop = `${marginTop}px`;
        }

        window.addEventListener('load', resizeGame);
        window.addEventListener('resize', resizeGame);

        // --- REFERENCIAS ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas ? canvas.getContext('2d') : null;
        const starCanvas = document.getElementById('starCanvas'); 
        const starCtx = starCanvas ? starCanvas.getContext('2d') : null;
        const bodyStarCanvas = document.getElementById('bodyStarCanvas');
        const bodyStarCtx = bodyStarCanvas ? bodyStarCanvas.getContext('2d') : null;
        
        const BACKGROUND_MUSIC = document.getElementById('backgroundMusic');
        const GAME_CONTAINER = document.getElementById('game-container');
        const GAME_CONTROLS = document.getElementById('game-controls'); 
        const SCORE_DISPLAY = document.getElementById('current-score');
        const LEVEL_DISPLAY = document.getElementById('current-level');
        const RECORD_DISPLAY = document.getElementById('record-display');
        const GAME_OVER_SCREEN = document.getElementById('game-over-screen');
        const FINAL_SCORE_DISPLAY = document.getElementById('final-score');
        const FINAL_LEVEL_DISPLAY = document.getElementById('final-level');
        const FINAL_DIFFICULTY_DISPLAY = document.getElementById('final-difficulty');
        const PAUSE_BUTTON = document.getElementById('pauseButton'); 
        const PAUSE_SCREEN = document.getElementById('pause-screen');
        const RESTART_BUTTON = document.getElementById('restartButton');
        const RESUME_BUTTON = document.getElementById('resumeButton');
        const PAUSE_TO_MENU_BUTTON = document.getElementById('pauseToMenuButton');
        const GAMEOVER_TO_MENU_BUTTON = document.getElementById('gameOverToMenuButton');

        // Men√∫s
        const MAIN_MENU = document.getElementById('main-menu');
        const MODE_SELECT_MENU = document.getElementById('mode-select-menu'); 
        const DIFFICULTY_SELECT_MENU = document.getElementById('difficulty-select-menu'); 
        const DIFFICULTY_BUTTONS_CONTAINER = document.getElementById('difficulty-buttons-container'); 
        
        const PLAY_BUTTON = document.getElementById('mainPlayButton');
        const ARCADE_MODE_BUTTON = document.getElementById('arcadeModeButton'); 
        const SETTINGS_MENU = document.getElementById('settings-menu');
        const HOW_TO_PLAY_MENU = document.getElementById('how-to-play-menu');
        const ABOUT_MENU = document.getElementById('about-menu');
        
        const SETTINGS_BUTTON = document.getElementById('mainSettingsButton');
        const HOW_TO_PLAY_BUTTON = document.getElementById('mainHowToPlayButton');
        const ABOUT_BUTTON = document.getElementById('mainAboutButton');
        const TOGGLE_SOUND_BUTTON = document.getElementById('toggleSoundButton');
        const TOGGLE_VIBRATION_BUTTON = document.getElementById('toggleVibrationButton');
        const LOADING_SCREEN = document.getElementById('loading-screen'); 
        
        // Configuraci√≥n
        const CELL_SIZE = 20;
        const GRID_WIDTH = canvas ? canvas.width / CELL_SIZE : 30; 
        const GRID_HEIGHT = canvas ? canvas.height / CELL_SIZE : 30; 

        // Variables Juego
        let snake, food, dx, dy, score, level, obstacles, gameLoopId, gameOver, gameSpeed, isPaused = false;
        let bodyStars = [];
        let bodyStarLoopId; 
        let highScore = 0; 
        let touchStartX = 0;
        let touchStartY = 0;
        const MIN_SWIPE_DISTANCE = 30;
        let floatOffset = 0; 
        let gameSettings = { sound: true, vibration: true };
        
        // --- R√âCORDS ---
        function getRecordKey() { return `cosmicSnakeHighScore_${currentDifficultyName}`; }
        function loadRecord() {
            const savedRecord = localStorage.getItem(getRecordKey());
            return savedRecord ? parseInt(savedRecord) : 0;
        }
        function saveRecord(newScore) {
            const currentRecord = loadRecord();
            if (newScore > currentRecord) {
                localStorage.setItem(getRecordKey(), newScore);
                return true; 
            }
            return false;
        }
        
        // --- SONIDO/VIBRACI√ìN ---
        function triggerVibration(pattern = [50]) {
            if (gameSettings.vibration && navigator.vibrate) navigator.vibrate(pattern);
        }
        
        function playSound(type) { /* Placeholder SFX */ }
        
        function playMusic() {
            if (gameSettings.sound && BACKGROUND_MUSIC) {
                BACKGROUND_MUSIC.volume = 0.5; 
                BACKGROUND_MUSIC.play().catch(e => console.log("Music play failed:", e)); 
            }
        }
        function pauseMusic() { if (BACKGROUND_MUSIC) BACKGROUND_MUSIC.pause(); }
        
        // --- SPRITES ---
        const SNAKE_HEAD_IMAGE = new Image(); SNAKE_HEAD_IMAGE.src = 'https://i.postimg.cc/HLj35t9Z/V%C3%ADborita_cabeza.png';
        const SNAKE_BODY_IMAGE = new Image(); SNAKE_BODY_IMAGE.src = 'https://i.postimg.cc/Bn0fP4n8/copilot-image-1765350583859.png';
        const SNAKE_TAIL_IMAGE = new Image(); SNAKE_TAIL_IMAGE.src = 'https://i.postimg.cc/dV54Lfrx/V%C3%ADborita_colita.png';
        const SNAKE_CURVE_IMAGE = new Image(); SNAKE_CURVE_IMAGE.src = 'https://i.postimg.cc/DwvxfhJK/Viborita_girar.png'; 
        const FOOD_IMAGE = new Image(); FOOD_IMAGE.src = 'https://i.postimg.cc/zf3pWkkq/Bolita_manzanacosmica.png';
        const SPECIAL_FOOD_IMAGE = new Image(); SPECIAL_FOOD_IMAGE.src = 'https://i.postimg.cc/3w61ZDL8/Bolita_ovni.png';
        
        const ALIEN_IMAGES = [];
        const ALIEN_GREEN_IMAGE = new Image(); ALIEN_GREEN_IMAGE.src = 'https://i.postimg.cc/BvypC1hx/Alien1.png';
        const ALIEN_RED_IMAGE = new Image(); ALIEN_RED_IMAGE.src = 'https://i.postimg.cc/yN5jTSfd/Alien2.png';
        const ALIEN_BLUE_IMAGE = new Image(); ALIEN_BLUE_IMAGE.src = 'https://i.postimg.cc/jj9chJ8Q/Alien3.png';
        ALIEN_IMAGES.push(ALIEN_GREEN_IMAGE, ALIEN_RED_IMAGE, ALIEN_BLUE_IMAGE);
        
        const STATIC_MOON_BG = new Image(); STATIC_MOON_BG.src = 'https://i.postimg.cc/PryxZTF5/moon-surface-with-earth.png'; 
        
        const BASE_IMAGES = [];
        const BASE_ALIEN = new Image(); BASE_ALIEN.src = 'https://i.postimg.cc/xC48PWNR/Base-alien.png';
        const BASE_LUNA = new Image(); BASE_LUNA.src = 'https://i.postimg.cc/x8VPwVVQ/Base_luna.png';
        const BASE_MARTE = new Image(); BASE_MARTE.src = 'https://i.postimg.cc/bJtTVNMm/Base_marte.png';
        const BASE_VOLCANICA = new Image(); BASE_VOLCANICA.src = 'https://i.postimg.cc/KctfnjtL/Base_volcanica.png';
        const BASE_ESPACIAL = new Image(); BASE_ESPACIAL.src = 'https://i.postimg.cc/3NQZsQQy/Base_espacial.png';
        const BASE_TIERRA = new Image(); BASE_TIERRA.src = 'https://i.postimg.cc/QCgqsYj0/Base_terrestre.png';
        BASE_IMAGES.push(BASE_ALIEN, BASE_LUNA, BASE_MARTE, BASE_VOLCANICA, BASE_ESPACIAL, BASE_TIERRA);
        let currentBaseImage = BASE_IMAGES[0];
        
        const ALL_IMAGES = [
            SNAKE_HEAD_IMAGE, SNAKE_BODY_IMAGE, SNAKE_TAIL_IMAGE, SNAKE_CURVE_IMAGE, 
            FOOD_IMAGE, SPECIAL_FOOD_IMAGE, 
            ALIEN_GREEN_IMAGE, ALIEN_RED_IMAGE, ALIEN_BLUE_IMAGE, 
            STATIC_MOON_BG,
            BASE_ALIEN, BASE_LUNA, BASE_MARTE, BASE_VOLCANICA, BASE_ESPACIAL, BASE_TIERRA 
        ];
        const totalImages = ALL_IMAGES.length;
        let loadedImages = 0;
        let spritesLoaded = false;

        function checkImagesLoaded() {
            loadedImages++;
            if (loadedImages === totalImages) {
                spritesLoaded = true;
                drawStaticBackground(); 
                if (LOADING_SCREEN) LOADING_SCREEN.style.display = 'none';
                resizeGame(); 
                showMenu(MAIN_MENU); 
            }
        }
        
        ALL_IMAGES.forEach(img => {
            img.onload = checkImagesLoaded;
            img.onerror = () => { console.error(`Error img: ${img.src}`); checkImagesLoaded(); };
            if (img.complete) { setTimeout(checkImagesLoaded, 0); }
        });

        // --- DIFICULTAD ---
        const DIFFICULTIES_MAP = {
            "F√°cil": { name: "F√°cil", speedFactor: 1.0, foodToSpeedUp: 9999, foodToLevelUp: 5, initialSpeed: 300, maxObstacleFactor: 0.8, specialFoodFrequency: 5, allowPause: true },
            "Normal": { name: "Normal", speedFactor: 0.99, foodToSpeedUp: 10, foodToLevelUp: 5, initialSpeed: 200, maxObstacleFactor: 1.5, specialFoodFrequency: 10, allowPause: true },
            "Dif√≠cil": { name: "Dif√≠cil", speedFactor: 0.99, foodToSpeedUp: 3, foodToLevelUp: 5, initialSpeed: 150, maxObstacleFactor: 2.5, specialFoodFrequency: 10, allowPause: true } 
        };
        const DIFFICULTY_ORDER = ["F√°cil", "Normal", "Dif√≠cil"];
        let currentDifficultyName = "Normal";
        let currentDifficulty = DIFFICULTIES_MAP[currentDifficultyName]; 

        // --- MEN√öS ---
        function showMenu(elementToShow) {
            [MAIN_MENU, MODE_SELECT_MENU, DIFFICULTY_SELECT_MENU, SETTINGS_MENU, HOW_TO_PLAY_MENU, ABOUT_MENU, GAME_CONTAINER, GAME_OVER_SCREEN, PAUSE_SCREEN, GAME_CONTROLS].forEach(el => {
                if (el) el.style.display = 'none';
            });
            
            if (elementToShow) {
                elementToShow.style.display = 'flex';
                if (elementToShow === GAME_CONTAINER && GAME_CONTROLS) {
                    GAME_CONTROLS.style.display = 'flex';
                }
            }
            resizeGame(); 
        }

        function startGame() {
            if (!spritesLoaded) { alert('Cargando...'); return; }
            playMusic();
            if (!gameSettings.sound) pauseMusic();
            showMenu(GAME_CONTAINER);
            initGame();
        }

        function togglePause() {
            if (gameOver || !currentDifficulty.allowPause) return; 
            isPaused = !isPaused;
            if (isPaused) {
                clearInterval(gameLoopId);
                pauseMusic(); 
                if (PAUSE_SCREEN) PAUSE_SCREEN.style.display = 'flex';
                if (PAUSE_BUTTON) PAUSE_BUTTON.textContent = '‚ñ∂Ô∏è';
            } else {
                gameLoopId = setInterval(gameTick, gameSpeed);
                playMusic(); 
                if (PAUSE_SCREEN) PAUSE_SCREEN.style.display = 'none';
                if (PAUSE_BUTTON) PAUSE_BUTTON.textContent = '‚è∏Ô∏è';
            }
        }

        function drawStaticBackground() {
            if (!starCtx || !starCanvas) return;
            starCtx.drawImage(STATIC_MOON_BG, 0, 0, starCanvas.width, starCanvas.height);
        }

        // --- CAMBIO DE ESCENARIO CORREGIDO ---
        function changeBaseRandomly() {
            if (BASE_IMAGES.length > 1) { // Aseguramos que hay al menos 2 para alternar
                let newImage;
                let attempts = 0;
                // Bucle para asegurar que el nuevo escenario NO sea el mismo que el actual
                do {
                    const randomIndex = Math.floor(Math.random() * BASE_IMAGES.length);
                    newImage = BASE_IMAGES[randomIndex];
                    attempts++;
                } while (newImage === currentBaseImage && attempts < 10);
                
                currentBaseImage = newImage;
            }
        }
        
        function createStars(starArray, targetCanvas, count) {
            starArray.length = 0;
            if (!targetCanvas) return; 
            for (let i = 0; i < count; i++) {
                starArray.push({
                    x: Math.random() * targetCanvas.width,
                    y: Math.random() * targetCanvas.height,
                    size: Math.random() * 2 + 0.5,
                    speed: Math.random() * 1.5 + 0.5 
                });
            }
        }
        
        function drawStars(starArray, targetCtx, targetCanvas) {
            if (!targetCtx || !targetCanvas) return;
            targetCtx.fillStyle = '#0b0c10'; 
            targetCtx.fillRect(0, 0, targetCanvas.width, targetCanvas.height);
            targetCtx.fillStyle = 'white'; 
            
            for (let i = 0; i < starArray.length; i++) {
                let star = starArray[i];
                star.x -= star.speed * 0.5; 
                star.y += star.speed * 0.2; 
                
                if (star.x < 0) star.x = targetCanvas.width;
                if (star.y > targetCanvas.height) star.y = 0;
                
                targetCtx.beginPath();
                targetCtx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                targetCtx.fill();
            }
        }

        function bodyStarLoop() {
            if (bodyStarCtx && bodyStarCanvas) drawStars(bodyStars, bodyStarCtx, bodyStarCanvas);
        }
        
        // --- L√ìGICA DE JUEGO ---
        function updateScoreBoard() {
            if (SCORE_DISPLAY) SCORE_DISPLAY.textContent = score;
            if (LEVEL_DISPLAY) LEVEL_DISPLAY.textContent = level;
            if (RECORD_DISPLAY) RECORD_DISPLAY.textContent = `| R√©cord: ${highScore}`;
        }

        function generateRandomPosition() {
            return { x: Math.floor(Math.random() * GRID_WIDTH), y: Math.floor(Math.random() * GRID_HEIGHT) };
        }

        function generateFood() {
            let newFoodPos;
            let isSpecial = (score > 0 && (score + 1) % currentDifficulty.specialFoodFrequency === 0);
            
            while (true) {
                newFoodPos = generateRandomPosition();
                let collisionWithSnake = snake.some(segment => segment.x === newFoodPos.x && segment.y === newFoodPos.y);
                let collisionWithObstacle = obstacles.some(obs => obs.x === newFoodPos.x && prevObstacle(obs, newFoodPos));

                if (!collisionWithSnake && !collisionWithObstacle) {
                    food = { x: newFoodPos.x, y: newFoodPos.y, isSpecial: isSpecial };
                    break;
                }
            }
        }
        function prevObstacle(obs, pos) { return obs.x === pos.x && obs.y === pos.y; }

        function regenerateObstacles() {
            obstacles = []; 
            const minObs = 5;
            const maxObs = Math.min(30, Math.floor(minObs * currentDifficulty.maxObstacleFactor + level * currentDifficulty.maxObstacleFactor));
            const numObstacles = Math.floor(Math.random() * (maxObs - minObs + 1)) + minObs;

            for (let k = 0; k < numObstacles; k++) {
                let newObsPos;
                while (true) {
                    newObsPos = generateRandomPosition();
                    let collisionWithSnake = snake.some(segment => segment.x === newObsPos.x && segment.y === newObsPos.y);
                    let collisionWithFood = (food && food.x === newObsPos.x && food.y === newObsPos.y);
                    let collisionWithExistingObstacle = obstacles.some(obs => obs.x === newObsPos.x && obs.y === newObsPos.y);
                    
                    const head = snake[0];
                    const safeDistance = 2; 
                    const isNearHead = Math.abs(newObsPos.x - head.x) <= safeDistance && Math.abs(newObsPos.y - head.y) <= safeDistance;

                    if (!collisionWithSnake && !collisionWithFood && !collisionWithExistingObstacle && !isNearHead) {
                        obstacles.push({
                            x: newObsPos.x,
                            y: newObsPos.y,
                            type: Math.floor(Math.random() * ALIEN_IMAGES.length)
                        });
                        break;
                    }
                }
            }
        }
        
        function generateObstacles() {
            const d = currentDifficulty;
            if (d.name === "Dif√≠cil") {
                if (score >= 1) regenerateObstacles();
            } else {
                if (score >= 3 && score % 3 === 0) regenerateObstacles();
            }
        }
        
        function isCurve(i) {
            if (i === 0 || i === snake.length - 1) return false;
            const current = snake[i];
            const prev = snake[i - 1];
            const next = snake[i + 1];
            const isStraight = (prev.x === current.x && current.x === next.x) || (prev.y === current.y && current.y === next.y);
            return !isStraight;
        }
        
        function drawSegment(segment, index, isFood = false, isObstacle = false) {
            const x = segment.x * CELL_SIZE;
            const y = segment.y * CELL_SIZE;
            const size = CELL_SIZE;
            const radius = size / 2;
            const centerX = x + radius;
            const centerY = y + radius;
            
            if (!ctx) return;
            let scaleFactor = 1.5; 
            let drawSize = size * scaleFactor;

            if (spritesLoaded) {
                if (isFood) {
                    const imageToUse = segment.isSpecial ? SPECIAL_FOOD_IMAGE : FOOD_IMAGE;
                    
                    if (segment.isSpecial) {
                         const SPECIAL_FOOD_SCALE = 1.5; 
                         drawSize = size * SPECIAL_FOOD_SCALE; 
                         
                         ctx.save();
                         const glowIntensity = 15 + Math.sin(Date.now() / 150) * 10; 
                         ctx.shadowBlur = glowIntensity;
                         ctx.shadowColor = "rgba(127, 255, 212, 0.9)"; 
                         
                         ctx.drawImage(imageToUse, x - (drawSize - size) / 2, y - (drawSize - size) / 2, drawSize, drawSize);
                         ctx.restore();
                    } else {
                         ctx.drawImage(imageToUse, x, y, size, size); 
                    }
                    return;
                }
                if (isObstacle) {
                    const alienImage = ALIEN_IMAGES[segment.type];
                    ctx.drawImage(alienImage, x - (drawSize - size) / 2, y - (drawSize - size) / 2 + floatOffset, drawSize, drawSize);
                    return;
                }
                
                let imageToDraw;
                let rotation = 0;
                
                if (index === 0) {
                    imageToDraw = SNAKE_HEAD_IMAGE;
                    if (dx === 1) rotation = Math.PI / 2;
                    else if (dx === -1) rotation = -Math.PI / 2;
                    else if (dy === 1) rotation = Math.PI;
                    
                } else if (index === snake.length - 1) {
                    imageToDraw = SNAKE_TAIL_IMAGE;
                    const prevSegment = snake[index - 1];
                    const diffX = segment.x - prevSegment.x;
                    const diffY = segment.y - prevSegment.y;
                    if (diffX === 1) rotation = Math.PI / 2;
                    else if (diffX === -1) rotation = -Math.PI / 2;
                    else if (diffY === 1) rotation = Math.PI;
                    
                } else if (isCurve(index)) {
                    imageToDraw = SNAKE_CURVE_IMAGE;
                    const current = segment;
                    const prev = snake[index - 1];
                    const next = snake[index + 1];

                    if ((prev.x < current.x && next.y > current.y) || (prev.y < current.y && next.x > current.x)) rotation = 0;
                    else if ((prev.x < current.x && next.y < current.y) || (prev.y > current.y && next.x > current.x)) rotation = -Math.PI / 2;
                    else if ((prev.x > current.x && next.y > current.y) || (prev.y < current.y && next.x < current.x)) rotation = Math.PI;
                    else if ((prev.x > current.x && next.y < current.y) || (prev.y > current.y && next.x < current.x)) rotation = Math.PI / 2;

                } else {
                    imageToDraw = SNAKE_BODY_IMAGE;
                    const prevSegment = snake[index - 1];
                    const diffX = segment.x - prevSegment.x;
                    if (diffX !== 0) rotation = Math.PI / 2;
                }
                
                ctx.save();
                ctx.translate(centerX, centerY); 
                ctx.rotate(rotation);
                ctx.drawImage(imageToDraw, -drawSize / 2, -drawSize / 2, drawSize, drawSize);
                ctx.restore();
            }
        }

        function clearCanvas() { if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height); }

        function drawGame() {
            clearCanvas();
            if (currentBaseImage && ctx) ctx.drawImage(currentBaseImage, 0, 0, canvas.width, canvas.height);
            drawSegment(food, -1, true, false); 
            obstacles.forEach(obs => drawSegment(obs, -2, false, true)); 
            for (let i = 0; i < snake.length; i++) drawSegment(snake[i], i, false, false);
        }

        function checkCollision() {
            const head = snake[0];
            if (head.x < 0 || head.x >= GRID_WIDTH || head.y < 0 || head.y >= GRID_HEIGHT) return true;
            for (let i = 1; i < snake.length; i++) if (head.x === snake[i].x && head.y === snake[i].y) return true;
            for (let i = 0; i < obstacles.length; i++) if (head.x === obstacles[i].x && head.y === obstacles[i].y) return true;
            return false;
        }

        function initGame() {
            if (!canvas) return; 
            snake = [ { x: 10, y: 10 }, { x: 9, y: 10 }, { x: 8, y: 10 } ];
            dx = 1; dy = 0; 
            score = 0;
            level = 1;
            obstacles = []; 
            gameOver = false;
            isPaused = false;
            floatOffset = 0; 
            highScore = loadRecord();
            gameSpeed = currentDifficulty.initialSpeed;
            currentBaseImage = BASE_IMAGES[0];
            generateFood();
            updateScoreBoard();
            if (gameLoopId) clearInterval(gameLoopId);
            gameLoopId = setInterval(gameTick, gameSpeed);
            drawStaticBackground();
            if (GAME_OVER_SCREEN) GAME_OVER_SCREEN.style.display = 'none';
            if (PAUSE_BUTTON) PAUSE_BUTTON.textContent = '‚è∏Ô∏è';
        }

        function gameTick() {
            if (gameOver || isPaused) return;

            floatOffset = Math.sin(Date.now() / 200) * 3; 

            const head = { x: snake[0].x + dx, y: snake[0].y + dy };
            snake.unshift(head);

            if (checkCollision()) {
                gameOver = true;
                clearInterval(gameLoopId);
                pauseMusic(); 
                triggerVibration([200, 100, 200]);
                saveRecord(score);
                highScore = loadRecord();
                if (GAME_OVER_SCREEN) GAME_OVER_SCREEN.style.display = 'flex';
                if (FINAL_SCORE_DISPLAY) FINAL_SCORE_DISPLAY.textContent = score;
                if (FINAL_LEVEL_DISPLAY) FINAL_LEVEL_DISPLAY.textContent = level;
                if (FINAL_DIFFICULTY_DISPLAY) FINAL_DIFFICULTY_DISPLAY.textContent = currentDifficulty.name;
                return;
            }
            
            const wasSpecial = food.isSpecial;

            if (head.x === food.x && head.y === food.y) {
                score++; 
                playSound('eat'); 
                triggerVibration(50);

                if (wasSpecial) { 
                    changeBaseRandomly(); 
                    regenerateObstacles(); 
                }

                if (score > 0 && score % currentDifficulty.foodToSpeedUp === 0) { 
                    gameSpeed *= currentDifficulty.speedFactor; 
                    if (gameSpeed < 65) gameSpeed = 65; 
                    clearInterval(gameLoopId);
                    gameLoopId = setInterval(gameTick, gameSpeed);
                }
                
                if (score % currentDifficulty.foodToLevelUp === 0) { level++; }
                
                if (!wasSpecial) {
                   generateObstacles();
                }
                
                generateFood(); 
                updateScoreBoard();
            } else {
                snake.pop(); 
            }

            drawGame();
        }

        function changeDirection(new_dx, new_dy) {
            const goingUp = dy === -1;
            const goingDown = dy === 1;
            const goingLeft = dx === -1;
            const goingRight = dx === 1;

            if (new_dy === -1 && !goingDown) { dx = 0; dy = -1; } 
            else if (new_dy === 1 && !goingUp) { dx = 0; dy = 1; } 
            else if (new_dx === -1 && !goingRight) { dx = -1; dy = 0; } 
            else if (new_dx === 1 && !goingLeft) { dx = 1; dy = 0; }
        }
        
        function generateDifficultyButtons() {
            if (!DIFFICULTY_BUTTONS_CONTAINER) return;
            DIFFICULTY_BUTTONS_CONTAINER.innerHTML = ''; 

            DIFFICULTY_ORDER.forEach(diffName => {
                const button = document.createElement('button');
                button.className = 'menu-button';
                button.textContent = diffName;
                button.addEventListener('click', () => {
                    currentDifficultyName = diffName;
                    currentDifficulty = DIFFICULTIES_MAP[diffName];
                    startGame();
                });
                DIFFICULTY_BUTTONS_CONTAINER.appendChild(button);
            });
        }

        // --- Event Listeners ---
        function setupMenuNavigation() {
            PLAY_BUTTON.addEventListener('click', () => showMenu(MODE_SELECT_MENU)); 
            if (ARCADE_MODE_BUTTON) {
                ARCADE_MODE_BUTTON.addEventListener('click', () => { 
                    generateDifficultyButtons();
                    showMenu(DIFFICULTY_SELECT_MENU);
                });
            }
            SETTINGS_BUTTON.addEventListener('click', () => showMenu(SETTINGS_MENU));
            HOW_TO_PLAY_BUTTON.addEventListener('click', () => showMenu(HOW_TO_PLAY_MENU));
            ABOUT_BUTTON.addEventListener('click', () => showMenu(ABOUT_MENU));

            document.querySelectorAll('.back-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const targetId = e.target.getAttribute('data-target');
                    showMenu(document.getElementById(targetId));
                });
            });
        }

        function setupSettings() {
            TOGGLE_SOUND_BUTTON.addEventListener('click', () => {
                gameSettings.sound = !gameSettings.sound;
                TOGGLE_SOUND_BUTTON.textContent = `üîä Sonido: ${gameSettings.sound ? 'ON' : 'OFF'}`;
                if (gameSettings.sound && BACKGROUND_MUSIC.paused) playMusic(); 
                else if (!gameSettings.sound) pauseMusic(); 
            });

            TOGGLE_VIBRATION_BUTTON.addEventListener('click', () => {
                gameSettings.vibration = !gameSettings.vibration;
                TOGGLE_VIBRATION_BUTTON.textContent = `üì≥ Vibraci√≥n: ${gameSettings.vibration ? 'ON' : 'OFF'}`;
                if (gameSettings.vibration) triggerVibration(50);
            });
        }
        
        if (canvas) {
            canvas.addEventListener('touchstart', e => {
                if (GAME_CONTAINER.style.display === 'flex' && !isPaused) {
                    e.preventDefault(); 
                    const touch = e.touches[0];
                    touchStartX = touch.clientX;
                    touchStartY = touch.clientY;
                }
            }, {passive: false});

            canvas.addEventListener('touchend', e => {
                if (GAME_CONTAINER.style.display === 'flex' && !isPaused && touchStartX !== 0) {
                    const touch = e.changedTouches[0];
                    const deltaX = touch.clientX - touchStartX;
                    const deltaY = touch.clientY - touchStartY;

                    if (Math.abs(deltaX) > MIN_SWIPE_DISTANCE || Math.abs(deltaY) > MIN_SWIPE_DISTANCE) {
                        if (Math.abs(deltaX) > Math.abs(deltaY)) {
                            if (deltaX > 0) changeDirection(1, 0); else changeDirection(-1, 0); 
                        } else { 
                            if (deltaY > 0) changeDirection(0, 1); else changeDirection(0, -1); 
                        }
                    }
                    touchStartX = 0; touchStartY = 0;
                }
            });
        }
        
        document.addEventListener('keydown', e => {
            if (GAME_CONTAINER && GAME_CONTAINER.style.display === 'flex') { 
                if (!isPaused) {
                    if (e.key === 'ArrowUp') changeDirection(0, -1); 
                    else if (e.key === 'ArrowDown') changeDirection(0, 1); 
                    else if (e.key === 'ArrowLeft') changeDirection(-1, 0); 
                    else if (e.key === 'ArrowRight') changeDirection(1, 0);
                }
                if (e.key === 'p' || e.key === 'P') togglePause();
            }
        });
        
        if (RESTART_BUTTON) RESTART_BUTTON.addEventListener('click', startGame);
        
        if (PAUSE_TO_MENU_BUTTON) PAUSE_TO_MENU_BUTTON.addEventListener('click', () => showMenu(MAIN_MENU));
        if (GAMEOVER_TO_MENU_BUTTON) GAMEOVER_TO_MENU_BUTTON.addEventListener('click', () => showMenu(MAIN_MENU));
        
        if (PAUSE_BUTTON) PAUSE_BUTTON.addEventListener('click', togglePause);
        if (RESUME_BUTTON) RESUME_BUTTON.addEventListener('click', togglePause);

        function initBodyStars() {
             if (bodyStarCanvas) {
                bodyStarCanvas.width = window.innerWidth;
                bodyStarCanvas.height = window.innerHeight;
                createStars(bodyStars, bodyStarCanvas, 300);
            }
        }
        
        function initApp() {
            initBodyStars();
            window.addEventListener('resize', initBodyStars);
            if (bodyStarLoopId) clearInterval(bodyStarLoopId);
            if (bodyStarCtx) bodyStarLoopId = setInterval(bodyStarLoop, 30); 
            setupMenuNavigation();
            setupSettings();
            highScore = loadRecord();
        }

        initApp();
    </script>
</body>
</html>tApp();
    </script>
</body>
</html>